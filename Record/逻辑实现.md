# 面向异构SoC的函数调用机制
### 目标
实现一种基于软硬件的FPGA与CPU通信接口，它在保留了CPU与FPGA通信的优势的前提下，一方面充分利用FPGA的并行性能特性，提高某些运算的效率；另一方面可以增强CPU对FPGA调用的灵活程度，提高计算效率。同时，定义一个具备可移植性的接口规范，便于软件与硬件程序员的使用。
#### 片上系统的异构计算
片上系统（System-on-Chip，SoC）的异构计算是指通过在一个芯片上集成多个不同类型的
处理器和加速器，以实现高效、灵活和优化的计算。这种异构计算架构可以充分发
挥各种处理器和加速器的优势，针对不同的计算任务进行分配和协同工作，以提高
系统的性能。
##### 在异构计算中常见的处理器和加速器
+ 中央处理器（CPU）：通用计算任务
+ 图形处理器（GPU）：图形渲染和图像处理
+ 张量处理器（TPU）：用于加速人工智能和机器学习
+ 数字信号处理器（DSP）：数字信号处理和实时控制
+ 硬件加速器（例如FPGA、ASIC）：硬件加速器是定制化的处理器，根据特定的计算需求进行设计和优化。FPGA具有可重构的逻辑和数据通路，适合于快速原型开发和灵活的定制化计算。
##### 集成了FPGA与CPU的SoC
可同时具备FPGA的⼤规模并发式处理能⼒以及CPU的通⽤计算能⼒。但其也面临着一些问题， CPU对FPGA方也存在一定的局限性，如FPGA功能较为固定不够灵活。若采用库函数调用封装的方式，使得CPU对FPGA功能的使用更加多变。

### 结构设计
#### FPGA与CPU高效通信
+ SoC上函数调用
近似于系统调用的函数调用通信机制，来定义FPGA与CPU间的通信架构，FPGA被视为
CPU的一个外设进行处理，当CPU调用FPGA计算时，可以等效于陷入内核态的状态，
将计算移交给FPGA。
当需要进行一个函数调用来进行数的计算时，我们对于数据在CPU和FPGA之间通信需定义一个专门的函数，这个函数就是实现的函数调用。可将需发送的数据通过CPU写入寄存器中，然后FPGA通过系统（函数）调用从这些寄存器中获得需要的数据信息然后进行其工作，最后将返回的结果在放到寄存器里让CPU去读取。这样就得到了一个通用的系统调用，这个调用的功能是从CPU寄存器中取值然后将其发给FPGA特定区域。这里的寄存器，在CPU内可以通过定义内存的特定区域来进行实现，即从内存中取一段特定的地址空间视为发送数据的存储空间，CPU可以将待发送的数据存在这个地址空间中，FPGA可以从这一块内存区域取出数据进行运算。
+ DMA配置
在软件端与硬件端使用AXI协议通信：CPU对DMA进行AXI传输配置，以实现系统调用
自定义一款通用IP核：自定义结构体，CPU仅需将配置信息封装发送，即在不消耗CPU性能的前提下完成对DMA的配置
基于中间件的实现，有效减少CPU配置内容
#### 函数模块
##### 采用先入先出队列（FIFO）将数据存入一定的区域然后以特定的时序进行输出。
+ FIFO有着调整数据输入输出速率的作用，当数据的输入速率与数据的输出速率不同时,FIFO可以起着作为缓冲的临时存储区的作用，使得数据流的输入输出速率得到匹配。CPU可将数据先写入FIFO中，然后做其他工作，而设备也能很方便地从FIFO中异步读取数据。
+ FIFO也可用于不同时钟域之间，为不同时钟域的输入输出提供同步。在实际的数据流传
输场景中，数据会面临不得不从一个时钟域进入另一个时钟域的情况。在这种情况下使用FIFO可以将不同时钟域的数据传送速率进行调和，使得数据传输能够跨时钟域进行。这里的FIFO除了承担数据同步的作用，还能作为数据的临时存储区域，提供数据的暂时存放区。
+ FIFO的位宽是可以调整的，输入数据路径与输出数据路径之间数据位宽不匹配时，FIFO可以调整其位宽，用于数据位宽调整电路。
##### 矩阵加法模块
Verilog语言中的数据都由进制数字来进行表示，如1b`1,8d`10这样的表示形式。
若在FPGA内想要进行小数运算，可以采用xilinx官方提供的Floating-point IP核。这个IP核内部包含了基本的整数和浮点数的互换操作，以及对应的浮点数运算操作。但在小数运算前需要将其转化为对应的浮点数形式。在该IP中，可以有至多三个端口输入数据，同时可对操作符进行输入来控制该IP具体行为逻辑。考虑到时序的复杂性，在矩阵加法模块中不采用其操作符输入端口，而仅使用其两个数据输入端来进行数据的运算。
##### 数组乘法模块
与矩阵加法模块相似，在数组乘法模块中也使用了Floating-point IP核，其同样具
有两个数据输入端口，并省去了操作符输入端口。将输入的两个数据在写接口中同时输入。对于待运算的数据A与数据B，将其进行位扩展后合并为位宽等于A的位宽加上B的位宽的数据C，然后将数据C传入写接口，这样只需在写接口中对于传入数据进行解析即可，减少了时序的复杂程度以及结构处理不同函数功能的复杂程度，对结构进行了设计上的简化。传入的数据经过Floating-point IP运算后位宽正常，将其送入读接口进行输出即可。
##### 全并行排序模块
并行全比较算法是将待排序数据中的数据同时进行比较，这种方式非常迅速，但会消耗大量的比较器资源。其具体流程如下：第一个时钟周期，将其中一个数据和其他数据同时进行比
较，得到每个数据的比较结果。第二个时钟周期，将每个数据和其他数据比较后的结果位置标识符进行累加。第三个时钟周期，将每个数据根据自己的位置标识符得分重新分配位置到新的数组中。根据上述流程，并行全比较排序可以在三个时钟周期内就完成排序任务。将多个待排序数据合并后输入写接口即可完成全并行排序模块的设计。

#### 多通道DMA
##### AXI DMA IP
提供了内存和使用AXI4-Stream接口的目标外设之间的高带宽直
接内存访问，可以将CPU从数据传输任务中解放出来，提升了CPU的性能。
##### 单通道的DMA
考虑使用Simple DMA模式。这种模式允许在MM2S和S2MM通道上进行基本的DMA传输，并且只需占用少量的FPGA资源。启动DMA传输的过程包括设置DMACR、源地址、目的地址和长度寄存器。传输结束后，如果启用了中断，DMASR寄存器的相关通道位将被激活，产生中断信号。
##### 多通道的DMA
需要启动S/G模式来配置管理通道的数据流。
在S/G模式下，配置DMA操作首先需要设置控制寄存器和描述符指针。基本上，这涉及将传输参数（称为BD，即Buffer Descriptor）存储到内存中，并通过SG接口加载和更新BD的状态，以执行对特定内存位置的数据读写操作。
